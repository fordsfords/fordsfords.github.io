/* rsend.c - Program to demonstrate Windows corruption of UDP datagrams */
/* See http://blog.geeky-boy.com/2015/10/windows-corrupting-udp-datagrams.html */

#include <stdio.h>
#include <stdlib.h>
#include <windows.h>
#include <winsock2.h>
#include <ws2tcpip.h>
#include <string.h>
#include <sys\types.h>

/* Simple assert-style macro for error checking. */
#define CHK(cond_expr) do { \
  if (!(cond_expr)) { \
    char errmsg[256]; \
    fprintf(stderr, "FATAL ASSERT in %s:%d, failed assertion: (%s)", \
            __FILE__, __LINE__, #cond_expr); \
    exit(1); \
  }  \
} while (0)


/* Actual datagram that a user sent which caused a crash. */
unsigned char rogue[] = {
0x08,0x00,0x00,0x0e,0x30,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,
0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x00,0x90,
0x10,0x00,0x3c,0x1d,0xc9,0xc4,0xa7,0x00,0x04,0x00,0x28,0x08,0x24,0x80,0x00,0x10,
0xac,0x10,0x02,0x88,0x52,0x73,0xef,0xc4,0x02,0x80,0x5b,0xcc,0x31,0x27,0x4d,0x4e,
0x1d,0xc9,0xc4,0xa7,0xc2,0x04,0x75,0x34,0x34,0xa4,0xc5,0xb4,0x00,0x00,0x01,0xac,
0x10,0x02,0x88,0xef,0xc4,0x02,0x80,0x4e,0x4d,0x27,0x31,0x5b,0xcc,0x52,0x73,0x31,
0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,
0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x00,0x90,0x10,0x00,0x3c,
0x1d,0xc9,0xc4,0xa8,0x00,0x04,0x00,0x28,0x08,0x24,0x80,0x00,0x10,0xac,0x10,0x02,
0x88,0x52,0x73,0xef,0xc4,0x02,0x80,0x5b,0xcc,0x31,0x27,0x4d,0x4e,0x1d,0xc9,0xc4,
0xa8,0xc2,0x04,0x75,0x34,0x34,0xa4,0xc5,0xb4,0x00,0x00,0x01,0xac,0x10,0x02,0x88,
0xef,0xc4,0x02,0x80,0x4e,0x4d,0x27,0x31,0x5b,0xcc,0x52,0x73,0x32,0x50,0x50,0x50,
0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,
0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,
0x50,0x50,0x50,0x50,0x50,0x00,0x90,0x10,0x00,0x3c,0x1d,0xc9,0xc4,0xa9,0x00,0x04,
0x00,0x28,0x08,0x24,0x80,0x00,0x10,0xac,0x10,0x02,0x88,0x52,0x73,0xef,0xc4,0x02,
0x80,0x5b,0xcc,0x31,0x27,0x4d,0x4e,0x1d,0xc9,0xc4,0xa9,0xc2,0x04,0x75,0x34,0x34,
0xa4,0xc5,0xb4,0x00,0x00,0x01,0xac,0x10,0x02,0x88,0xef,0xc4,0x02,0x80,0x4e,0x4d,
0x27,0x31,0x5b,0xcc,0x52,0x73,0x33,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,
0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,
0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x00,
0x90,0x10,0x00,0x3c,0x1d,0xc9,0xc4,0xaa,0x00,0x04,0x00,0x28,0x08,0x24,0x80,0x00,
0x10,0xac,0x10,0x02,0x88,0x52,0x73,0xef,0xc4,0x02,0x80,0x5b,0xcc,0x31,0x27,0x4d,
0x4e,0x1d,0xc9,0xc4,0xaa,0xc2,0x04,0x75,0x34,0x34,0xa4,0xc5,0xb4,0x00,0x00,0x01,
0xac,0x10,0x02,0x88,0xef,0xc4,0x02,0x80,0x4e,0x4d,0x27,0x31,0x5b,0xcc,0x52,0x73,
0x34,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,
0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,
0x00,0x90,0x10,0x00,0x3c,0x1d,0xc9,0xc4,0xab,0x00,0x04,0x00,0x28,0x08,0x24,0x80,
0x00,0x10,0xac,0x10,0x02,0x88,0x52,0x73,0xef,0xc4,0x02,0x80,0x5b,0xcc,0x31,0x27,
0x4d,0x4e,0x1d,0xc9,0xc4,0xab,0xc2,0x04,0x75,0x34,0x34,0xa4,0xc5,0xb4,0x00,0x00,
0x01,0xac,0x10,0x02,0x88,0xef,0xc4,0x02,0x80,0x4e,0x4d,0x27,0x31,0x5b,0xcc,0x52,
0x73,0x35,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,
0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,
0x50,0x50,0x50,0x50,0x00,0x90,0x10,0x00,0x3c,0x1d,0xc9,0xc4,0xac,0x00,0x04,0x00,
0x28,0x08,0x24,0x80,0x00,0x10,0xac,0x10,0x02,0x88,0x52,0x73,0xef,0xc4,0x02,0x80,
0x5b,0xcc,0x31,0x27,0x4d,0x4e,0x1d,0xc9,0xc4,0xac,0xc2,0x04,0x75,0x34,0x34,0xa4,
0xc5,0xb4,0x00,0x00,0x01,0xac,0x10,0x02,0x88,0xef,0xc4,0x02,0x80,0x4e,0x4d,0x27,
0x31,0x5b,0xcc,0x52,0x73,0x36,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,
0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,
0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x00,0x90,0x10,0x00,0x3c,0x1d,0xc9,0xc4,
0xad,0x00,0x04,0x00,0x28,0x08,0x24,0x80,0x00,0x10,0xac,0x10,0x02,0x88,0x52,0x73,
0xef,0xc4,0x02,0x80,0x5b,0xcc,0x31,0x27,0x4d,0x4e,0x1d,0xc9,0xc4,0xad,0xc2,0x04,
0x75,0x34,0x34,0xa4,0xc5,0xb4,0x00,0x00,0x01,0xac,0x10,0x02,0x88,0xef,0xc4,0x02,
0x80,0x4e,0x4d,0x27,0x31,0x5b,0xcc,0x52,0x73,0x37,0x50,0x50,0x50,0x50,0x50,0x50,
0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,
0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x00,0x90,0x10,0x00,
0x3c,0x1d,0xc9,0xc4,0xaf,0x00,0x04,0x00,0x28,0x08,0x24,0x80,0x00,0x10,0xac,0x10,
0x02,0x88,0x52,0x73,0xef,0xc4,0x02,0x80,0x5b,0xcc,0x31,0x27,0x4d,0x4e,0x1d,0xc9,
0xc4,0xaf,0xc2,0x04,0x75,0x34,0x34,0xa4,0xc5,0xb4,0x00,0x00,0x01,0xac,0x10,0x02,
0x88,0xef,0xc4,0x02,0x80,0x4e,0x4d,0x27,0x31,0x5b,0xcc,0x52,0x73,0x38,0x50,0x50,
0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,
0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,
0x50,0x50,0x50,0x50,0x50,0x50,0x00,0x90,0x10,0x00,0x3c,0x1d,0xc9,0xc4,0xb0,0x00,
0x04,0x00,0x28,0x08,0x24,0x80,0x00,0x10,0xac,0x10,0x02,0x88,0x52,0x73,0xef,0xc4,
0x02,0x80,0x5b,0xcc,0x31,0x27,0x4d,0x4e,0x1d,0xc9,0xc4,0xb0,0xc2,0x04,0x75,0x34,
0x34,0xa4,0xc5,0xb4,0x00,0x00,0x01,0xac,0x10,0x02,0x88,0xef,0xc4,0x02,0x80,0x4e,
0x4d,0x27,0x31,0x5b,0xcc,0x52,0x73,0x39,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,
0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,
0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x00,0x90,0x10,0x00,0x3c,
0x1d,0xc9,0xc4,0xae,0x00,0x04,0x00,0x28,0x08,0x24,0x80,0x00,0x10,0xac,0x10,0x02,
0x88,0x52,0x73,0xef,0xc4,0x02,0x80,0x5b,0xcc,0x31,0x27,0x4d,0x4e,0x1d,0xc9,0xc4,
0xae,0xc2,0x04,0x75,0x34,0x34,0xa4,0xc5,0xb4,0x00,0x00,0x01,0xac,0x10,0x02,0x88,
0xef,0xc4,0x02,0x80,0x4e,0x4d,0x27,0x31,0x5b,0xcc,0x52,0x73,0x61,0x50,0x50,0x50,
0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,
0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x00,0x90,0x10,
0x00,0x3c,0x1d,0xc9,0xc4,0xb1,0x00,0x04,0x00,0x28,0x08,0x24,0x80,0x00,0x10,0xac,
0x10,0x02,0x88,0x52,0x73,0xef,0xc4,0x02,0x80,0x5b,0xcc,0x31,0x27,0x4d,0x4e,0x1d,
0xc9,0xc4,0xb1,0xc2,0x04,0x75,0x34,0x34,0xa4,0xc5,0xb4,0x00,0x00,0x01,0xac,0x10,
0x02,0x88,0xef,0xc4,0x02,0x80,0x4e,0x4d,0x27,0x31,0x5b,0xcc,0x52,0x73,0x62,0x50,
0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,
0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x00,0x90,0x10,0x00,
0x3c,0x1d,0xc9,0xc4,0xb2,0x00,0x04,0x00,0x28,0x08,0x24,0x80,0x00,0x10,0xac,0x10,
0x02,0x88,0x52,0x73,0xef,0xc4,0x02,0x80,0x5b,0xcc,0x31,0x27,0x4d,0x4e,0x1d,0xc9,
0xc4,0xb2,0xc2,0x04,0x75,0x34,0x34,0xa4,0xc5,0xb4,0x00,0x00,0x01,0xac,0x10,0x02,
0x88,0xef,0xc4,0x02,0x80,0x4e,0x4d,0x27,0x31,0x5b,0xcc,0x52,0x73,0x63,0x50,0x50,
0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,
0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,
0x00,0x90,0x10,0x00,0x3c,0x1d,0xc9,0xc4,0xb3,0x00,0x04,0x00,0x28,0x08,0x24,0x80,
0x00,0x10,0xac,0x10,0x02,0x88,0x52,0x73,0xef,0xc4,0x02,0x80,0x5b,0xcc,0x31,0x27,
0x4d,0x4e,0x1d,0xc9,0xc4,0xb3,0xc2,0x04,0x75,0x34,0x34,0xa4,0xc5,0xb4,
0x00,0x00,               /* rogue[1278] and rogue[1279] */
0x01,0xac,0x10,0x02,0x88,0xef,0xc4,0x02,0x80,0x4e,0x4d,0x27,0x31,0x5b,0xcc,0x52,
0x73,0x64,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,
0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,
0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x50,0x00,0x90,0x10,0x00,0x3c,0x1d,
0xc9,0xc4,0xa5,0x00,0x04,0x00,0x28,0x08,0x24,0x80,0x00,0x10,0xac,0x10,0x02,0x88,
0x52,0x73,0xef,0xc4,0x02,0x80,0x5b,0xcc,0x31,0x27,0x4d,0x4e,0x1d,0xc9,0xc4,0xa5,
0xc2,0x04,0x75,0x34,0x34,0xa4,0xc5,0xb4,0x00,0x00,0x01,0xac,0x10,0x02,0x88,0xef,
0xc4,0x02,0x80,0x4e,0x4d,0x27,0x31,0x5b,0xcc,0x52,0x73,0x81,0x0c,0x80,0x00,0xc6,
0x05,0x18,0x83,0x9f,0x85,0x66,0x6f,0x82,0x04,0x80,0x00,0x83,0x08,0x80,0x00,0x06,
0x05,0x00,0x00,0x84,0x08,0x80,0x00,0x00,0x00,0x03,0xea,0x80,0x04,0x00,0x24
};
/* 1278 = 0x4fe, plus UDP/IP hdr */


int main(int argc, char **argv)
{
  /* program positional parameters */
  unsigned long groupaddr;
  unsigned short groupport;
  char *bind_if;
  SOCKET sock;
  struct sockaddr_in dest_sin;
  unsigned int ttl;
  unsigned long int iface_in;
  struct ip_mreq imr;
  WSADATA wsadata;
  int status;

  CHK(argc == 2);

  status = WSAStartup(MAKEWORD(2,2), &wsadata);  CHK(status == 0);

  groupaddr = inet_addr("239.196.2.128");
  groupport = 12000;
  bind_if = argv[1];

  sock = socket(PF_INET, SOCK_DGRAM, 0);  CHK(sock != INVALID_SOCKET);

  /* Set the multicast time-to-live */
  ttl = 15;
  status = setsockopt(sock, IPPROTO_IP, IP_MULTICAST_TTL, (char *)&ttl,
             sizeof(ttl));  CHK(status != SOCKET_ERROR);

  iface_in = inet_addr(bind_if);
  status = setsockopt(sock, IPPROTO_IP, IP_MULTICAST_IF, (char *)&iface_in,
                      sizeof(iface_in));  CHK(status != SOCKET_ERROR);

  /* Join the multicast group so that the socket will receive messages.
   * This does not have to be done in this process.  You can have a different
   * process join the multicast group and the corruption will still happen. */
  memset((char *)&imr, 0, sizeof(imr));
  imr.imr_multiaddr.s_addr = groupaddr;
  imr.imr_interface.s_addr = inet_addr(bind_if);
  status = setsockopt(sock, IPPROTO_IP, IP_ADD_MEMBERSHIP, (const char*)&imr,
                      sizeof(struct ip_mreq));  CHK(status != SOCKET_ERROR);

  /* Prepare destination address for sendto() */
  memset((char *)&dest_sin, 0, sizeof(dest_sin));
  dest_sin.sin_family = AF_INET;
  dest_sin.sin_addr.s_addr = groupaddr;
  dest_sin.sin_port = htons(groupport);

  while (1) {
    status = sendto(sock, rogue, sizeof(rogue), 0, (struct sockaddr *)&dest_sin,
                    sizeof(dest_sin));  CHK(status == sizeof(rogue));

    Sleep(1000);  /* One send per second */
  }  /* while */

  return(0);
}  /* main */
